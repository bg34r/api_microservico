name: Go

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  
jobs:
  test-coverage:
    runs-on: ubuntu-latest
    outputs:
      coverage-passed: ${{ steps.coverage-check.outputs.passed }}
      coverage-percentage: ${{ steps.coverage-check.outputs.coverage }}
    
    steps:
      - name: Fazer checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para SonarCloud

      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Instalar dependÃªncias
        run: go mod download

      - name: Executar testes com cobertura
        run: |
          echo "ğŸ” Executando todos os testes com cobertura..."
          go test -v -coverprofile=coverage.out ./...
          echo "ğŸ“Š Gerando relatÃ³rio..."
          go tool cover -func=coverage.out > coverage.txt
          echo "ğŸ“‹ RelatÃ³rio gerado:"
          cat coverage.txt

      - name: Verificar limite de cobertura
        id: coverage-check
        run: |
          echo "ğŸ“Š Analisando cobertura de testes..."
          
          # Verificar se o arquivo existe
          if [ ! -f coverage.out ]; then
            echo "âŒ Arquivo coverage.out nÃ£o foi encontrado!"
            exit 1
          fi
          
          # Extrair cobertura
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          
          if [ -z "$COVERAGE" ]; then
            echo "âŒ NÃ£o foi possÃ­vel extrair a porcentagem de cobertura!"
            exit 1
          fi
          
          echo "ğŸ¯ RESULTADO DA COBERTURA:"
          echo "   â€¢ Cobertura atual: ${COVERAGE}%"
          echo "   â€¢ Limite mÃ­nimo: 70%"
          
          # Verificar se atende o limite usando awk (mais confiÃ¡vel que bc)
          if awk "BEGIN {exit !($COVERAGE >= 70)}"; then
            echo ""
            echo "âœ… SUCESSO: Cobertura de ${COVERAGE}% atende o limite mÃ­nimo de 70%"
            echo "ğŸš€ Pull Request pode prosseguir!"
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ FALHA: Cobertura de ${COVERAGE}% estÃ¡ abaixo do limite mÃ­nimo de 70%"
            echo "ğŸ“ˆ Adicione mais testes para atingir o requisito"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: AnÃ¡lise SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        if: always()  # Executar mesmo se a cobertura falhar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload dos relatÃ³rios de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: relatorio-cobertura
          path: |
            coverage.out
            coverage.txt

  build:
    needs: test-coverage
    if: needs.test-coverage.outputs.coverage-passed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Fazer checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          
      - name: Compilar aplicaÃ§Ã£o
        run: go build -v -o main main.go
  
      - name: Upload do artefato de build
        uses: actions/upload-artifact@v4
        with:
          name: programa
          path: main 

  docker:
    needs: [test-coverage, build]
    if: needs.test-coverage.outputs.coverage-passed == 'true'
    uses: ./.github/workflows/Docker.yml
    secrets: inherit

  coverage-gate:
    needs: test-coverage
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Controle de Cobertura
        run: |
          echo "ğŸ¯ GATE DE COBERTURA - Resultado Final"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ "${{ needs.test-coverage.outputs.coverage-passed }}" != "true" ]; then
            echo "âŒ STATUS: REJEITADO"
            echo "ğŸ“Š Cobertura: ${{ needs.test-coverage.outputs.coverage-percentage }}% (abaixo de 70%)"
            echo "ğŸš« Pull Request bloqueado por cobertura insuficiente"
            echo ""
            echo "ğŸ“‹ PRÃ“XIMOS PASSOS:"
            echo "   1. Adicione mais testes unitÃ¡rios"
            echo "   2. Execute 'go test -cover ./...' localmente"
            echo "   3. Foque nos arquivos com menor cobertura"
            echo "   4. FaÃ§a novo commit quando atingir 70%+"
            exit 1
          else
            echo "âœ… STATUS: APROVADO"
            echo "ğŸ“Š Cobertura: ${{ needs.test-coverage.outputs.coverage-percentage }}% (acima de 70%)"
            echo "ğŸ‰ Requisitos de cobertura atendidos"
            echo "ğŸš€ PR liberado para merge na branch main!"
          fi